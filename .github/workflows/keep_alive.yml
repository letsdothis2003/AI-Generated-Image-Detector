name: Keep App Awake

on:
  schedule:
    # This runs every 11 hours to keep the Streamlit app active
    - cron: '0 */11 * * *'
  workflow_dispatch: # Helps with demonstrations without having to deal with Streamlit sleeping 

jobs:
  maintenance_ping:
    name: "Ping Streamlit Cloud Instance"
    runs-on: ubuntu-latest
    
    steps:
      - name: "Timestamping Request"
        run: |
          echo "Initiating keep-alive ping at $(date)"
          echo "Target: https://ai-generated-image-detector-letsdothis2003.streamlit.app"

      - name: "Aggressive Wake-up Ping"
        continue-on-error: true
        run: |
          # We use a loop to poke the server 3 times. 
          # This ensures that even if the first request triggers a 'Wake Up', 
          # the subsequent ones confirm the app is active.
          for i in {1..3}; do
            echo "Ping Attempt $i..."
            curl -L -v -k \
              -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8" \
              -H "Upgrade-Insecure-Requests: 1" \
              -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36" \
              --max-time 30 \
              https://ai-generated-image-detector-letsdothis2003.streamlit.app || true
            sleep 10
          done

      - name: "Final Verification"
        run: |
          # This final check confirms the status code. 
          # We accept 200 (OK) or 302/304 (Redirects) as success.
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -L -k https://ai-generated-image-detector-letsdothis2003.streamlit.app)
          echo "Final Status Code: $STATUS"
          if [ "$STATUS" -eq "200" ] || [ "$STATUS" -eq "302" ] || [ "$STATUS" -eq "304" ]; then
            echo "App is confirmed AWAKE."
          else
            echo "App might still be booting, but the wake-up signal was sent."
          fi
